<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLI Specification - Ploinky</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <div class="logo-icon">🚀</div>
                    <span>Ploinky</span>
                </a>
                <nav>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="cli-reference.html">CLI Reference</a></li>
                        <li><a href="spec-services.html">Services</a></li>
                        <li><a href="spec-webtty.html">WebTTY</a></li>
                        <li><a href="spec-cli.html" class="active">CLI Spec</a></li>
                        <li><button class="theme-toggle" id="themeToggle">🌙</button></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="doc-layout">
                <aside class="sidebar">
                    <h3>CLI Components</h3>
                    <ul>
                        <li><a href="#structure">Project Structure</a></li>
                        <li><a href="#entry">Entry Points</a></li>
                        <li><a href="#commands">Command System</a></li>
                        <li><a href="#client">Client Commands</a></li>
                        <li><a href="#interactive">Interactive Mode</a></li>
                        <li><a href="#lifecycle">Process Lifecycle</a></li>
                        <li><a href="#logging">Logging System</a></li>
                        <li><a href="#errors">Error Handling</a></li>
                    </ul>
                </aside>

                <div class="content-wrapper">
                    <div class="doc-section">
                        <h1>CLI Implementation Specification</h1>
                        <p class="subtitle">Technical details of Ploinky's command-line interface implementation.</p>
                    </div>

                    <div class="doc-section" id="structure">
                        <h2>Project Structure</h2>
                        
                        <h3>Directory Layout</h3>
                        <pre><code>ploinky/
├── bin/
│   ├── ploinky              # Main CLI entry script
│   └── p-cli                 # Alias/shorthand
├── cli/
│   ├── index.js             # CLI bootstrap
│   ├── commands/
│   │   ├── cli.js           # Main command handler
│   │   └── client.js        # Client operations
│   ├── services/            # Service layer
│   ├── server/              # Routing server
│   ├── webtty/              # Web interfaces
│   └── logs/                # Logging utilities
├── Agent/                   # Agent runtime
│   └── AgentServer.js       # Default supervisor
├── dashboard/               # Dashboard components
└── package.json             # Dependencies</code></pre>

                        <h3>Package Configuration</h3>
                        <pre><code>// package.json
{
  "name": "ploinky",
  "version": "1.0.0",
  "bin": {
    "ploinky": "./bin/ploinky",
    "p-cli": "./bin/p-cli"
  },
  "dependencies": {
    "express": "^4.18.0",
    "ws": "^8.0.0",
    "node-pty": "^0.10.0",
    "http-proxy": "^1.18.0",
    "express-session": "^1.17.0"
  },
  "scripts": {
    "postinstall": "node scripts/setup.js"
  }
}</code></pre>
                    </div>

                    <div class="doc-section" id="entry">
                        <h2>Entry Points</h2>
                        
                        <h3>Binary Script (bin/ploinky)</h3>
                        <pre><code>#!/usr/bin/env node

// Set up environment
process.env.PLOINKY_ROOT = __dirname + '/..';

// Load CLI module
require('../cli/index.js');</code></pre>

                        <h3>CLI Bootstrap (cli/index.js)</h3>
                        <pre><code>const path = require('path');
const { handleCommand } = require('./commands/cli');

// Parse arguments
const args = process.argv.slice(2);

// Interactive mode if no arguments
if (args.length === 0) {
    startInteractiveMode();
} else {
    // Execute command
    handleCommand(args)
        .then(() => process.exit(0))
        .catch(err => {
            console.error('Error:', err.message);
            process.exit(1);
        });
}

function startInteractiveMode() {
    const readline = require('readline');
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout,
        prompt: 'ploinky> '
    });
    
    console.log('Ploinky Interactive Mode. Type "help" for commands.');
    rl.prompt();
    
    rl.on('line', async (line) => {
        const args = line.trim().split(/\s+/);
        if (args[0] === 'exit') {
            rl.close();
            return;
        }
        
        try {
            await handleCommand(args);
        } catch (err) {
            console.error('Error:', err.message);
        }
        
        rl.prompt();
    });
}</code></pre>
                    </div>

                    <div class="doc-section" id="commands">
                        <h2>Command System</h2>
                        <p><strong>File:</strong> <code>cli/commands/cli.js</code></p>
                        
                        <h3>Command Handler Architecture</h3>
                        <pre><code>async function handleCommand(args) {
    const [command, ...options] = args;
    
    switch (command) {
        // Repository management
        case 'add':
            if (options[0] === 'repo') {
                addRepo(options[1], options[2]);
            }
            break;
            
        // Agent operations
        case 'enable':
            if (options[0] === 'agent') {
                await enableAgent(options[1]);
            } else if (options[0] === 'repo') {
                enableRepo(options[1]);
            }
            break;
            
        // Workspace management
        case 'start':
            await startWorkspace(options[0], options[1]);
            break;
            
        // Interactive commands
        case 'shell':
            await runShell(options[0]);
            break;
            
        case 'cli':
            await runCli(options[0], options.slice(1));
            break;
            
        // Web interfaces (with token security)
        case 'webconsole':
        case 'webtty':
            await runConsole(...options);
            break;
            
        case 'webchat':
            process.env.WEBTTY_MODE = 'chat';
            await runConsole(...options);
            break;
            
        case 'dashboard':
            await runDashboard();
            break;
            
        case 'admin-mode':
            await runAdminMode(...options);
            break;
            
        // Client operations
        case 'client':
            const ClientCommands = require('./client');
            await new ClientCommands().handleClientCommand(options);
            break;
            
        // System commands
        case 'status':
            await statusWorkspace();
            break;
            
        case 'stop':
        case 'shutdown':
        case 'clean':
        case 'destroy':
            await handleSystemCommand(command);
            break;
            
        // Help
        case 'help':
            showHelp(options);
            break;
            
        default:
            // Try to execute as bash command
            executeBashCommand(command, options);
    }
}</code></pre>

                        <h3>Command Categories</h3>
                        <table class="command-table">
                            <tr>
                                <th>Category</th>
                                <th>Commands</th>
                                <th>Purpose</th>
                            </tr>
                            <tr>
                                <td>Repository</td>
                                <td>add repo, enable repo, disable repo, list repos</td>
                                <td>Manage agent repositories</td>
                            </tr>
                            <tr>
                                <td>Agent</td>
                                <td>new agent, enable agent, update agent, list agents</td>
                                <td>Agent lifecycle management</td>
                            </tr>
                            <tr>
                                <td>Workspace</td>
                                <td>start, restart, status</td>
                                <td>Workspace operations</td>
                            </tr>
                            <tr>
                                <td>Interactive</td>
                                <td>shell, cli</td>
                                <td>Container interaction</td>
                            </tr>
                            <tr>
                                <td>Web</td>
                                <td>webconsole, webchat, dashboard, admin-mode</td>
                                <td>Web interfaces</td>
                            </tr>
                            <tr>
                                <td>Client</td>
                                <td>client task, client methods, client status</td>
                                <td>API interactions</td>
                            </tr>
                            <tr>
                                <td>System</td>
                                <td>stop, shutdown, clean, destroy</td>
                                <td>Container management</td>
                            </tr>
                        </table>
                    </div>

                    <div class="doc-section" id="client">
                        <h2>Client Commands</h2>
                        <p><strong>File:</strong> <code>cli/commands/client.js</code></p>
                        
                        <h3>Client Implementation</h3>
                        <pre><code>class ClientCommands {
    async handleClientCommand(args) {
        const [subcommand, ...options] = args;
        
        switch (subcommand) {
            case 'task':
                await this.runTask(options[0]);
                break;
            case 'methods':
                await this.getMethods(options[0]);
                break;
            case 'status':
                await this.getStatus(options[0]);
                break;
        }
    }
    
    async runTask(agentName) {
        // Load routing configuration
        const routing = this.loadRouting();
        const route = routing.routes[agentName];
        
        if (!route) {
            throw new Error(`Agent '${agentName}' not found`);
        }
        
        // Interactive task mode
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout,
            prompt: `${agentName}> `
        });
        
        console.log('Interactive task mode. Type commands:');
        rl.prompt();
        
        rl.on('line', async (line) => {
            const [method, ...params] = line.trim().split(/\s+/);
            
            // Send to agent API
            const response = await this.callAgent(
                route.hostPort,
                method,
                params
            );
            
            console.log(response);
            rl.prompt();
        });
    }
    
    async callAgent(port, method, params) {
        const url = `http://localhost:${port}/api/${method}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ params })
        });
        
        return response.json();
    }
}</code></pre>
                    </div>

                    <div class="doc-section" id="interactive">
                        <h2>Interactive Mode Features</h2>
                        
                        <h3>Shell Access</h3>
                        <pre><code>async function runShell(agentName) {
    // Find agent and manifest
    const { manifestPath, shortAgentName } = findAgent(agentName);
    const manifest = JSON.parse(fs.readFileSync(manifestPath));
    
    // Ensure container is running
    const { containerName } = ensureAgentService(
        shortAgentName,
        manifest,
        path.dirname(manifestPath)
    );
    
    // Attach to container with TTY
    const runtime = getRuntime();
    const child = spawn(runtime, [
        'exec', '-it',
        '-w', process.cwd(),
        containerName,
        '/bin/sh'
    ], {
        stdio: 'inherit'
    });
    
    // Wait for exit
    return new Promise(resolve => {
        child.on('exit', resolve);
    });
}</code></pre>

                        <h3>CLI Command Execution</h3>
                        <pre><code>async function runCli(agentName, args) {
    const { manifestPath, shortAgentName } = findAgent(agentName);
    const manifest = JSON.parse(fs.readFileSync(manifestPath));
    
    // Get CLI command from manifest
    const cliBase = manifest.cli || manifest.run || 'sh';
    const cmd = cliBase + (args.length ? ' ' + args.join(' ') : '');
    
    // Ensure container and attach
    const { containerName } = ensureAgentService(
        shortAgentName,
        manifest,
        path.dirname(manifestPath)
    );
    
    attachInteractive(containerName, process.cwd(), cmd);
}</code></pre>
                    </div>

                    <div class="doc-section" id="lifecycle">
                        <h2>Process Lifecycle</h2>
                        
                        <h3>Startup Sequence</h3>
                        <pre><code>// ploinky start demo 8088
async function startWorkspace(staticAgent, port) {
    // 1. Save configuration
    if (staticAgent) {
        workspace.setConfig({
            static: { agent: staticAgent, port: port || 8088 }
        });
    }
    
    // 2. Load configuration
    const config = workspace.getConfig();
    if (!config.static) {
        throw new Error('No static agent configured');
    }
    
    // 3. Apply manifest directives
    await applyManifestDirectives(config.static.agent);
    
    // 4. Start agent containers
    const agents = workspace.loadAgents();
    for (const [name, agent] of Object.entries(agents)) {
        const { containerName, hostPort } = ensureAgentService(
            agent.agentName,
            manifest,
            agentPath
        );
        
        // Update routing
        routes[agent.agentName] = { containerName, hostPort };
    }
    
    // 5. Save routing configuration
    fs.writeFileSync('.ploinky/routing.json', 
        JSON.stringify({ port, static: config.static, routes }));
    
    // 6. Start RoutingServer
    const child = spawn('node', [
        path.resolve(__dirname, '../server/RoutingServer.js')
    ], {
        stdio: 'inherit',
        env: { ...process.env, PORT: port }
    });
    
    // 7. Save PID
    writePidFile('router', child.pid);
    
    // 8. Wait for termination
    await new Promise(resolve => {
        child.on('exit', resolve);
    });
}</code></pre>

                        <h3>Shutdown Sequence</h3>
                        <pre><code>async function shutdownWorkspace() {
    // 1. Stop web services
    killWebTTYIfRunning();
    killWebChatIfRunning();
    killDashboardIfRunning();
    
    // 2. Stop RoutingServer
    killRouterIfRunning();
    
    // 3. Stop agent containers
    const agents = workspace.loadAgents();
    for (const [name, agent] of Object.entries(agents)) {
        const runtime = getRuntime();
        try {
            execSync(`${runtime} stop ${name}`, { stdio: 'ignore' });
            execSync(`${runtime} rm ${name}`, { stdio: 'ignore' });
        } catch {}
    }
    
    // 4. Clean PID files
    fs.rmSync('.ploinky/running', { recursive: true, force: true });
    
    console.log('Workspace shutdown complete');
}</code></pre>
                    </div>

                    <div class="doc-section" id="logging">
                        <h2>Logging System</h2>
                        <p><strong>File:</strong> <code>cli/logs/logger.js</code></p>
                        
                        <h3>Logger Implementation</h3>
                        <pre><code>class Logger {
    constructor(name) {
        this.name = name;
        this.logFile = path.join('.ploinky/logs', `${name}.log`);
        this.ensureLogDir();
    }
    
    ensureLogDir() {
        fs.mkdirSync(path.dirname(this.logFile), { recursive: true });
    }
    
    log(level, message, ...args) {
        const timestamp = new Date().toISOString();
        const formatted = `[${timestamp}] [${level}] ${message}`;
        
        // Console output
        if (process.env.DEBUG || level === 'ERROR') {
            console.log(formatted, ...args);
        }
        
        // File output
        fs.appendFileSync(this.logFile, formatted + '\n');
        
        // Rotate if needed
        this.rotateIfNeeded();
    }
    
    rotateIfNeeded() {
        const stats = fs.statSync(this.logFile);
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (stats.size > maxSize) {
            const archived = `${this.logFile}.${Date.now()}`;
            fs.renameSync(this.logFile, archived);
            
            // Keep only last 5 archives
            this.cleanOldLogs();
        }
    }
    
    info(message, ...args) {
        this.log('INFO', message, ...args);
    }
    
    error(message, ...args) {
        this.log('ERROR', message, ...args);
    }
    
    debug(message, ...args) {
        if (process.env.DEBUG) {
            this.log('DEBUG', message, ...args);
        }
    }
}

module.exports = { Logger };</code></pre>

                        <h3>Log Viewing</h3>
                        <pre><code>// View logs commands
async function logsTail(kind) {
    const logFile = getLogPath(kind);
    
    if (!fs.existsSync(logFile)) {
        console.log(`No log file: ${logFile}`);
        return;
    }
    
    // Use tail -f for real-time following
    const tail = spawn('tail', ['-f', logFile], {
        stdio: 'inherit'
    });
    
    // Handle Ctrl+C
    process.on('SIGINT', () => {
        tail.kill();
        process.exit(0);
    });
    
    await new Promise(resolve => {
        tail.on('exit', resolve);
    });
}

function showLast(count, kind) {
    const logFile = getLogPath(kind);
    const lines = parseInt(count) || 100;
    
    const output = execSync(`tail -n ${lines} ${logFile}`, {
        encoding: 'utf8'
    });
    
    console.log(output);
}</code></pre>
                    </div>

                    <div class="doc-section" id="errors">
                        <h2>Error Handling</h2>
                        
                        <h3>Error Types</h3>
                        <pre><code>// Custom error classes
class AgentNotFoundError extends Error {
    constructor(agentName) {
        super(`Agent '${agentName}' not found in any repository`);
        this.name = 'AgentNotFoundError';
        this.agentName = agentName;
    }
}

class ContainerError extends Error {
    constructor(message, containerName) {
        super(message);
        this.name = 'ContainerError';
        this.containerName = containerName;
    }
}

class ConfigurationError extends Error {
    constructor(message) {
        super(message);
        this.name = 'ConfigurationError';
    }
}</code></pre>

                        <h3>Error Recovery</h3>
                        <pre><code>// Graceful error handling
async function safeExecute(fn, errorMessage) {
    try {
        return await fn();
    } catch (error) {
        if (error.code === 'ENOENT') {
            console.error(`File not found: ${error.path}`);
        } else if (error.code === 'EADDRINUSE') {
            console.error(`Port already in use: ${error.port}`);
        } else if (error.code === 'EACCES') {
            console.error(`Permission denied: ${error.path}`);
        } else {
            console.error(errorMessage || 'Operation failed:', error.message);
        }
        
        // Log full error in debug mode
        if (process.env.DEBUG) {
            console.error(error.stack);
        }
        
        return null;
    }
}

// Container recovery
async function ensureContainerHealthy(containerName) {
    const maxRetries = 3;
    let retries = 0;
    
    while (retries < maxRetries) {
        try {
            const running = isContainerRunning(containerName);
            if (running) return true;
            
            // Try to start
            startContainer(containerName);
            await sleep(1000);
            
            // Verify started
            if (isContainerRunning(containerName)) {
                return true;
            }
        } catch (error) {
            console.warn(`Retry ${retries + 1}/${maxRetries}: ${error.message}`);
        }
        
        retries++;
    }
    
    throw new Error(`Failed to ensure container ${containerName} is healthy`);
}</code></pre>

                        <h3>Cleanup Handlers</h3>
                        <pre><code>// Process cleanup
process.on('SIGINT', async () => {
    console.log('\nReceived SIGINT, cleaning up...');
    
    try {
        // Stop any session containers
        await cleanupSessionContainers();
        
        // Kill any spawned processes
        for (const child of spawnedProcesses) {
            child.kill('SIGTERM');
        }
    } catch (error) {
        console.error('Cleanup error:', error);
    }
    
    process.exit(0);
});

process.on('uncaughtException', (error) => {
    console.error('Uncaught exception:', error);
    logger.error('Uncaught exception', error.stack);
    process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled rejection at:', promise, 'reason:', reason);
    logger.error('Unhandled rejection', reason);
    process.exit(1);
});</code></pre>
                    </div>

                    <div class="doc-section">
                        <h2>CLI Extensions</h2>
                        
                        <h3>Custom Commands</h3>
                        <p>Add custom commands by extending the command handler:</p>
                        <pre><code>// In handleCommand function
case 'custom':
    const customHandler = require('./custom-commands');
    await customHandler.execute(options);
    break;

// custom-commands.js
module.exports = {
    async execute(args) {
        const [subcommand, ...options] = args;
        
        switch (subcommand) {
            case 'deploy':
                await this.deploy(options);
                break;
            case 'backup':
                await this.backup(options);
                break;
        }
    },
    
    async deploy(options) {
        // Custom deployment logic
    },
    
    async backup(options) {
        // Custom backup logic
    }
};</code></pre>

                        <h3>Plugin System</h3>
                        <pre><code>// Load plugins from .ploinky/plugins
function loadPlugins() {
    const pluginDir = path.join('.ploinky', 'plugins');
    if (!fs.existsSync(pluginDir)) return [];
    
    const plugins = [];
    const files = fs.readdirSync(pluginDir);
    
    for (const file of files) {
        if (file.endsWith('.js')) {
            const plugin = require(path.join(pluginDir, file));
            plugins.push(plugin);
        }
    }
    
    return plugins;
}

// Register plugin commands
const plugins = loadPlugins();
for (const plugin of plugins) {
    if (plugin.commands) {
        Object.assign(commandHandlers, plugin.commands);
    }
}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Ploinky Project. Built with security and simplicity in mind.</p>
            <p>
                <a href="https://github.com/ploinky/ploinky">GitHub</a> • 
                <a href="index.html">Home</a> • 
                <a href="cli-reference.html">CLI Reference</a>
            </p>
        </div>
    </footer>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        body.setAttribute('data-theme', savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.textContent = newTheme === 'dark' ? '☀️' : '🌙';
        });

        // Highlight active section
        const sections = document.querySelectorAll('.doc-section[id]');
        const navLinks = document.querySelectorAll('.sidebar a');
        
        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 100) {
                    current = section.getAttribute('id');
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>